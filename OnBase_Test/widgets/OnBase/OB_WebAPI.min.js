var OnBaseWebApi=function(){function yt(){function ui(){var t=!1,i,n,u;return r!==null&&r.WidgetConfig.WidgetActionMenuOptions.IsShowActionMenuFilter===!0&&(i=ri(),n=fi(),n!==null&&(u=ObGisStorage.getItem(i,n),u&&(t=!0))),t}function yt(n,t,i,r,u,f){var e={url:n,async:!0,cache:!1,type:u||"GET",dataType:t,xhrFields:{withCredentials:!0}},o;return f&&(e.cache=!0),i&&(e.data=i,e.contentType=r,e.type="POST"),o="OB_WebAPI._execAjaxRequestAsync:: error calling "+n,$.ajax(e).fail(vr(o,!0))}function wi(){var n=$.Deferred();if(ui()){var i=fi(),r=ri(),u=ObGisStorage.getItem(r,i),f=t+"/SetBrowserPersistedFilters";yt(f,"text",u,"application/json","POST").always(function(){n.resolve()})}else n.resolve();return n}function fi(){var n=null;return r!==null&&(n=r.WidgetConfig.WidgetActionMenuOptions.IsPersistFilterInBrowser?EnumObStorageType.LOCAL:EnumObStorageType.SESSION),n}function bi(){var n=t+"/GetClientConfiguration";return yt(n,"json").then(function(n){r=n;rt=r.LoginPage;ft=r.XCOORD_CALC;et=r.YCOORD_CALC;vt=r.WidgetConfig.IsIncludeDeviceCoordinates;ot=r.WidgetConfig.IsIncludeFeatureCoordinates})}function ki(){var n=t+"/GetActionMenuState";return yt(n,"json").then(function(n){it=n})}function bt(n,i){var r=$.Deferred();if(n&&(f=null,st("_getConfiguredLayersAsync: cleared ob configured layers client cache.")),f===null){var u=t+"/GetConfiguredLayers",e=function(n){f=n;st("_getConfiguredLayersAsync: ob configured layers are now cached.")},o=function(){return yt(u,"json")},s=function(n){n&&i===!0?r.resolve(null):n?(wt(),r.resolve(null)):wi().then(o).then(e).always(function(){r.resolve(f)})};pt().then(s)}else r.resolve(f);return r}function ei(n){var i=t+"/RetrieveDocuments",r=JSON.stringify(n);bt().then(function(){return yt(i,"json",r,"application/json").then(function(n){return k=new Date,n})})}function ni(n){var r=t+"/RetrieveDocumentsHtml",i=$.Deferred();return ci().then(function(){if(n===undefined||n===null||n.length===0)w===""?ti(["STR_RC_GIS_LAYER_NOTCONFIGURED_NONE"]).then(function(n){w=n[0];i.resolve(w)}):i.resolve(w);else{var t=JSON.stringify(n);yt(r,"html",t,"application/json").then(function(n){k=new Date;i.resolve(n)}).fail(function(n){n.done&&n.fail&&n.always&&i.resolve("<div>"+ut+"<\/div>")})}}),i}function di(t){var r=$.Deferred(),u=[];return bt().then(function(){var f,e,o,l,a,s;for(i=0;i<t.length;i++)if(f=t[i],e=f.obCityworksName||f.name,hi(e))if(f.visible){var v=f.fields,h=[],c=f.getSelectedFeatures();for(c.length>0?st('_getObFeaturesFromEsriLayersAsync: Getting features for layer "'+e+'"',n.Log):st('_getObFeaturesFromEsriLayersAsync: No features calling getSelectedFeatures on layer "'+e+'"',n.Log),o=0;o<c.length;o++)l=c[o],gi(l),a=kt(l.attributes,!0,v),h.push(a);s=null;h.length>0&&(s=dt(e,h));s!==null&&u.push(s)}else st("_getObFeaturesFromEsriLayersAsync: Layer name '"+e+"' configured layer not visible and ignored.");r.resolve(u)}),r}function gi(n){var t,i;ot&&(t=nr(n.geometry),t&&esri.geometry.webMercatorToGeographic?(i=t.spatialReference.wkid===4326?t:esri.geometry.webMercatorToGeographic(t),n.attributes[ft]=i.x.toFixed(3),n.attributes[et]=i.y.toFixed(3),st("_setCoordinates: Added (x,y)"+i.x.toFixed(3)+","+i.y.toFixed(3))):st("_setCoordinates: Failed to get map point or load esri.geometry.webMercatorToGeographic."))}function nr(t){var i=null;return t.type==="polygon"?i=t.getCentroid():t.type==="multipoint"?st("_getPointFromGeometry: Cannot get point from Multipoint",n.Info):t.type==="polyline"?st("_getPointFromGeometry: Cannot get point from Polyline",n.Info):t.type==="point"?i=t:t.type==="extent"?i=t.getCenter():st("_getPointFromGeometry: Invalid geometry type '"+typeof t+"'. Point conversion ignored."),i}function ti(n){var i=t+"/BulkTranslateRCs";return yt(i,"json",JSON.stringify(n),"application/json")}function tr(n){var i=t+"/LogExceptionMessage",r=JSON.stringify(escape(n));return yt(i,"text",r,"application/json")}function ii(){return li().then(oi)}function oi(){var n=t+"/HasSession";return yt(n,"text").then(function(n){return n.indexOf("true")===0})}function ir(){var n=t+"/RequireAPILogin";return yt(n,"text").then(function(n){return n.indexOf("true")===0})}function pt(){var n=$.Deferred();return l===null?ir().then(function(t){l=t;st("_requiresSessionAsync: Require API login: "+l);l?ii().then(function(t){n.resolve(!t)}):n.resolve(!1)}):l?ii().then(function(t){n.resolve(!t)}):n.resolve(!1),n}function rr(){var n=$.Deferred(),i=t+"/DisconnectSession";return yt(i,"text",null,null,"POST").then(function(t){t.indexOf("true")===0?(ai(d),st("_disconnectSessionAsync: Session disconnected."),n.resolve()):n.reject("Error receiving disconnect confirmation from server.")}),n}function ur(){var i=$.Deferred(),r=t+"/GetRequiredHitListScripts",n;if(h){for(n=0;n<h.length;n++)yi(h[n]);i.resolve()}else yt(r,"json").then(function(n){h=n;for(var t=0;t<h.length;t++)yi(h[t]);i.resolve()});return i}function fr(){var i=$.Deferred(),r=t+"/GetRequiredHitListCSS",n;if(c){for(n=0;n<c.length;n++)pi(c[n]);i.resolve()}else yt(r,"json").then(function(n){c=n;for(var t=0;t<c.length;t++)pi(c[t]);i.resolve()});return i}function er(){var n=$.Deferred(),i=t+"/GetWidgetViewHtml";return yt(i,"html").then(function(t){n.resolve(t)}),n}function or(n,t,i){var u=$.Deferred(),r=null;return ci().then(function(){er().then(function(f){var o={map:n,obApi:e,queryArcGISDynamicMapServiceLayers:i.QueryArcGISDynamicMapServiceLayers,addDynamicSelectionToMap:i.AddDynamicSelectionToMap,useOBHighlighting:i.ShouldUseHighlightingOverride,selFillColor:i.SelectionFillColor,selOutlineColor:i.SelectionOutlineColor,toolFillColor:i.ToolFillColor,toolOutlineColor:i.ToolOutlineColor,selectionType:i.SelectionType,debugMode:i.ConsoleLogging,identifyQueryTolerance:i.IdentifyQueryTolerance,disableInfoWindowInDrawMode:i.DisableInfoWindowInDrawMode,queryDistance:i.PointAndLineTolerance,cityworksProxyObj:i.cityworksProxyObj||null};r=new t(o);r.wireUpUI(f,i);u.resolve(r)})}),u}function si(t){var r=-1,i,u,e;if(f!==null){for(i=0;i<f.length;i++)if(u=f[i].Name.toLowerCase(),e=t.toLowerCase(),u===e){r=f[i].Id;break}}else st("_getConfiguredLayerId: Warning: ob configured layers have not been retrieved from the server.",n.Warn);return r}function kt(n,t,i){var f=[],r,u;for(r in n)featureProperties={},featureProperties.Key=t?ar(i,r):r,featureProperties.Value=n[r],f.push(featureProperties);return u={},u.FeatureProperties=f,u}function dt(n,t,i){var r=si(n),u=null;return r===-1&&i!==undefined&&i===!0?st("_createObLayer: Layer name '"+n+"' not found in configured layers."):u=new sr(r,n,t),u}function sr(n,t,i){this.LayerId=n;this.LayerName=t;this.Features=i}function gt(n,t){for(var e,r,u,a,v,h,c,l=[],f=0,y=t.length;f<y;f++){for(e=[],r="",u=0,a=n.length;u<a;u++){var i=n[u],o=-1,s=!1;i.layerId!==undefined?o=i.layerId:(o=i._layer.layerId,s=!0);o===t[f]&&(v=i.feature,r===""&&(r=s?i._layer.name:i.layerName),h=null,h=s?kt(i.attributes):kt(v.attributes),e.push(h))}r!==""&&(c=dt(r,e,!0),c!==null&&l.push(c))}return l}function hr(t,i){return bt().then(function(){var o=[],c,r,l,u,f,s,e,a,h;try{if(c=t&&t.length&&i&&i.length,c)for(r=0,l=i.length;r<l;r++)if(u=i[r],u&&u.length){for(f=t[r],s=[],e=0,a=u.length;e<a;e++){var v=u[e],y=v.attributes,p=kt(y,!0,f.fields);s.push(p)}h=dt(f.name,s,!0);h?o.push(h):st("_getObLayersFromIdentifyOrQueryAsync: data could not be converted to an OnBase layer. FeatureLayer: "+f.name,n.Warn)}}catch(w){st("_getObLayersFromIdentifyOrQueryAsync: error converting data from identify or query operation. Ensure valid data is being passed in. "+w.message,n.Error)}return o.length===0&&st("_getObLayersFromIdentifyOrQueryAsync: None of the layers passed in were able to be converted to OnBase layers.",n.Warn),o})}function hi(n){var t=!1;return si(n)!==-1&&(t=!0),t}function ci(){return ur().then(fr).then(li)}function li(){var n=$.Deferred();return p===""?ti(["STR_RC_GIS_LOGIN_REFRESH","STR_RC_GIS_LOGIN_TRYAGAIN","STR_RC_REFRESH","STR_RC_GIS_HITLIST_LOGGINGIN","STR_RC_GIS_SELECTFEATURES","STR_RC_GIS_CLEARSELECTEDFEATS","STR_RC_GIS_RESPONSE_ERROR","STR_RC_GIS_CLOSE"]).then(function(t){p=t[0];nt=t[1];g=t[2];ht=t[3];ct=t[4];lt=t[5];ut=t[6];at=t[7];cr();n.resolve()}):n.resolve(),n}function wt(){var i=y+rt+"?apimode=true",r=800,u=600,e="OB_LoginWindow",t;if(f=null,st("_handle401: cleared ob configured layers client cache."),t=null,s!==null)try{s.closed?(s=null,t=vi(i,e,r,u),s=t):s.focus()}catch(o){st("_handle401: Error accessing login window : "+o.message,n.Error)}else t=vi(i,e,r,u),s=t}function cr(){tt?(o="<div id='divObDocsRefresh'><p>"+nt+"<\/p><button type='button' class='ob-text-btn' onclick='javascript:OnBaseWebApi.currentInstance().refreshHtmlAsync(true);'>"+g+"<\/button><\/div>",d="<div id='divObDocsRefresh'><p>"+p+"<\/p><button type='button' class='ob-text-btn' onclick='javascript:OnBaseWebApi.currentInstance().refreshHtmlAsync(true);'>"+g+"<\/button><\/div>"):(o="<div id='divObDocsRefresh'><p>"+nt+"<\/p><\/div>",d="<div id='divObDocsRefresh'><p>"+p+"<\/p><\/div>")}function ai(n){$("#OB_MainDiv").length>0&&$("#OB_MainDiv").html(n)}function lr(n){var t=$("#OB_MainDiv"),i;t&&(i=t.parent(),i&&(t.remove(),i.html(n)))}function vi(n,t,i,r){wleft=(screen.width-i)/2;wtop=(screen.height-r)/2;wleft<0&&(wleft=0);wtop<0&&(wtop=0);var f="width="+i+", height="+r+", left="+wleft+", top="+wtop+", location=no, menubar=no, status=yes, toolbar=no, scrollbars=yes, resizable=yes",u=window.open(n,t,f);return u.focus(),u}function yi(t){var o=t.toLowerCase().indexOf("jquery")!==-1,e=t.toLowerCase().indexOf("jquery-ui")!==-1,i=!0,u,f,r;for(o&&window.jQuery&&!e?i=!1:e&&typeof jQuery.ui!="undefined"&&typeof jQuery.ui.dialog!="undefined"&&(i=!1,jQuery.dialog=="undefined"&&st("_appendScript: Missing Jquery Dialog in Jquery UI. Errors may occur.",n.Warn)),u=document.getElementsByTagName("script"),f=u.length;f--;)if(u[f].src.toLowerCase()===t.toLowerCase()){i=!1;break}if(i){r=document.createElement("script");r.setAttribute("type","text/javascript");r.setAttribute("src",t);try{$("head").append(r)}catch(s){st("_appendScript: Failed to add script: "+t+" error: "+s.message,n.Error)}}}function pi(n){if(!($('head link[href="'+n+'"]').length>0)){var t=document.createElement("link");t.setAttribute("type","text/css");t.setAttribute("rel","Stylesheet");t.setAttribute("href",n);$("head").append(t)}}function ar(n,t){for(var r,u=t,i=0;i<n.length;i++)if(r=n[i],r.name===t){u=r.alias;break}return u}function vr(n,t){var i=function(t){console&&console.error(n+" "+t)};return t&&(i=function(t,i,r){console&&(errText="[errthrown:] "+r+" [status:] "+i,t.responseText&&(errText+=" [responseTxt:] "+t.responseText),console.error(n+" "+errText))}),i}function st(t,i,r){var u;if(b&&console){u=r?"[debug] "+r:"[debug] OBWebAPI: ";switch(i){case n.Error:console.error(u+t);console.trace();break;case n.Info:console.info(u+t);break;case n.Verbose:console.info(u+t);console.trace();break;case n.Warn:console.warn(u+t);break;default:console.log(u+t)}}else i===n.Error&&console&&(u=r?r:"OB_WebAPI: ",console.error(u+t),console.trace())}function yr(){return r.Path}function ri(){var n=yr().replace(new RegExp("/","g"),"");return"obGisApiFilter_"+n}return{createObFeature:function(n,t,i){return kt(n,t,i)},createObLayer:function(n,t){return dt(n,t,!0)},getObLayersFromIdentifyOrQueryAsync:function(n,t){return hr(n,t)},isConfiguredLayerId:function(n){return hi(n)},getConfiguredLayersAsync:function(n,t){return bt(n,t)},retrieveDocumentsJsonAsync:function(n){u=n;var t=$.Deferred();return pt().then(function(i){i&&wt();ei(n).then(function(n){t.resolve(n)})}),t},retrieveDocumentsJsonExtAsync:function(n,t){a=n;v=t;u=null;var i=$.Deferred();return pt().then(function(r){r?wt():(u=gt(n,t),ei(u).then(function(n){i.resolve(n)}))}),i},retrieveDocumentsHtmlAsync:function(n){var t=$.Deferred();return u=n,pt().then(function(i){i?(wt(),t.resolve(o)):ni(n).then(function(n){t.resolve(n)})}),t},refreshHtmlAsync:function(n){var t=$.Deferred();return pt().then(function(i){i?(wt(),n&&ai(o),t.resolve(o)):bt().then(function(){u===null&&(u=gt(a,v));ni(u).then(function(i){n&&lr(i);t.resolve(i)})})}),t},retrieveDocumentsHtmlExtAsync:function(n,t){a=n;v=t;u=null;var i=$.Deferred();return pt().then(function(r){r?(wt(),i.resolve(o)):(u=gt(n,t),ni(u).then(function(n){i.resolve(n)}))}),i},convertEsriFeatures:function(){return u===null&&a!==null&&(u=gt(a,v)),u},requiresSessionAsync:function(){return pt()},hasSessionAsync:function(){return oi()},disconnectSessionAsync:function(){var n=$.Deferred();return ii().then(function(t){t?rr().then(function(){n.resolve()}):n.resolve()}),n},logExceptionMessageAsync:function(n){return tr(n)},log:function(n,t,i){st(n,t,i)},promptForSession:function(){return wt(),o},getObFeaturesFromEsriLayersAsync:function(n){return di(n)},createWidgetAsync:function(t,i,u){var e=$.Deferred(),f=r.WidgetConfig;return u&&$.each(u,function(n,t){f[n]=t}),b=f.ConsoleLogging===!0?!0:!1,$(f.JQueryWidgetDivId).length>0?or(t,i,f).then(function(n){e.resolve(n)}):(st("createWidgetAsync: Missing required widget div with id '"+f.JQueryWidgetDivId.replace("#","")+"' see Web.config widget configuration for details.",n.Error),e.reject("Could not create widget. Missing required html element.")),e},bulkTranslateRCsAsync:function(n){return ti(n)},getClientConfigurationAsync:function(){var n=$.Deferred();return r===null?bi().then(function(){n.resolve(r)}):n.resolve(r),n},getGetActionMenuStateAsync:function(){var n=$.Deferred();return ki().then(function(){n.resolve(it)}),n},getWebApiUrl:function(){return t},hasFilterApplied:function(){return ui()},execAjaxRequestAsync:function(n,t,i,r,u,f){return yt(n,t,i,r,u,f)},toggleLoadingSpinner:function(n){n?$("#ob_working_div").show():$("#ob_working_div").hide()},getLastResultsUpdateTime:function(){return k},determineFilterLocalStorageKeyName:function(){return ri()},clearObConfiguredLayersCache:function(){f=null;st("clearObConfiguredLayersCache: cleared ob configured layers client cache.")},esriJsVersion:"",EnumLogType:n}}var b=!1,tt=!0,e=null,s=null,h=null,c=null,f=null,l=null,u=null,a=null,v=null,k=null,st="api/GisService",r=null,it=null,rt="",y="",t="",o="",d="",g="",p="",nt="",ht="",w="",ct="",lt="",ut="",at="",ft="",et="",vt=!0,ot=!0,n={Log:"log",Error:"error",Info:"info",Verbose:"verbose",Warn:"warn"};return{getInstanceAsync:function(n,i,r){function f(n,t){return n.indexOf(t,n.length-t.length)!==-1}if(!n)throw"rootUrl required";var u=$.Deferred();return e===null?(e=yt(),y=f(n,"/")?n:n+"/",t=y+st,i&&(tt=!1),b=r,e.getClientConfigurationAsync().then(function(){e.log("OB_WebAPI.getInstanceAsync: Initialized OB Web API at: "+t);u.resolve(e)})):u.resolve(e),u},clearInstance:function(){e=null},currentInstance:function(){return e||console&&console.error("OBWebAPI: You must call getInstance before calling currentInstance"),e}}}(),EnumObStorageType,ObGisStorage;typeof define!="undefined"&&define(["dojo/_base/declare","dojo/_base/lang"],function(n){return n(null,{constructor:function(n,t,i){this.rootUrl=n;this.bExcludeRefreshButton=t;this.shouldLogConsole=i},getInstanceAsync:function(){return OnBaseWebApi.getInstanceAsync(this.rootUrl,this.bExcludeRefreshButton,this.shouldLogConsole)},clearInstance:function(){OnBaseWebApi.clearInstance()}})});EnumObStorageType={LOCAL:"local",SESSION:"session",COOKIE:"cookie"};ObGisStorage=function(){function i(i){switch(i){case EnumObStorageType.SESSION:n=t[EnumObStorageType.SESSION];break;case EnumObStorageType.COOKIE:n=t[EnumObStorageType.COOKIE];break;default:n=t[EnumObStorageType.LOCAL]}}function r(n){var t=null;return t=n===EnumObStorageType.SESSION?window.sessionStorage:window.localStorage,{getItem:function(n){return t.getItem(n)},setItem:function(n,i){t.setItem(n,i)},removeItem:function(n){t.removeItem(n)}}}function u(){function n(n,t){var r=new Date("January 01, 1970 00:00:00"),i=n+"=; expires="+r.toUTCString()+";";i+=t?" path="+t:" path=/";document.cookie=i}function t(n,t,i,r){var u=n+"="+encodeURIComponent(t)+";";if(i){var f=new Date,e=f.getTime(),o=i*864e5,s=e+o;f.setTime(s);u+=" expires="+f.toUTCString()+";"}u+=r?" path="+r:" path=/";document.cookie=u}function i(n){var t=null,i=r(n);if(i)try{t=decodeURIComponent(i.substring(n.length+1))}catch(u){console&&console.error("OnBaseByHyland:: getCookieValue error: "+u.message)}return t}function r(n){var i=document.cookie,r=null,f=null,t,e,u;if(i&&typeof i=="string")for(r=i.split(";"),t=0,e=r.length;t<e;t++)if(u=r[t].trim(),u.substr(0,n.length)===n){f=u;break}return f}return{getItem:function(n){return i(n)},setItem:function(n,i){t(n,i,null,"/")},removeItem:function(t){n(t,"/")}}}var n=null,t={};return t[EnumObStorageType.LOCAL]=new r(EnumObStorageType.LOCAL),t[EnumObStorageType.SESSION]=new r(EnumObStorageType.SESSION),t[EnumObStorageType.COOKIE]=new u,{getItem:function(t,r){var u=r||EnumObStorageType.LOCAL;return i(u),n.getItem(t)},setItem:function(t,r,u){var f=u||EnumObStorageType.LOCAL;i(f);n.setItem(t,r)},removeItem:function(t,r){var u=r||EnumObStorageType.LOCAL;i(u);n.removeItem(t)}}}();