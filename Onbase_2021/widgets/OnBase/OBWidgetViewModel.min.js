define(["dojo/_base/declare","dojo/on","dojo/_base/lang","dojo/_base/array","dojo/promise/all","esri/renderers/SimpleRenderer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/Color","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/tasks/QueryTask","esri/tasks/query","esri/toolbars/draw"],function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w){var b=null,tt="_Menu",nt="obDisplayLayer_",d={Log:"log",Error:"error",Info:"info",Warn:"warn"},k={Attach:"attach",Detach:"detach",Download:"download",Import:"import",Filter:"filter",Folder:"folder",Refresh:"refresh",Weblink:"weblink",LogoutLoginPrompt:"logoutLoginPrompt",Logout:"logout",ToggleMenu:"togglemenu",CloseWorkflowDialog:"closeWorkflowDialog"},g={LoginClose:"close.aspx",Filter:"filter.aspx",UnKnown:"unknown"};return n(null,{constructor:function(n){if(!n.map)throw new Error("OBWidgetViewModel:: esri map instance is undefined. Widget view model cannot continue.");if(!n.obApi)throw new Error("OBWidgetViewModel:: OBWebAPI instance must be instantiated prior to calling Widget view model constructor.");if(b=this,this._OnUnLoadCloseWindowsSet=!1,this._hasInitialActionMenuItems=!1,this._hasWiredAttach=!1,this._hasWiredDetach=!1,this._hasWiredImport=!1,this._hasWiredDownload=!1,this._hasWiredFolder=!1,this._hasWiredRefresh=!1,this._hasWiredLogout=!1,this._hasWiredWeblink=!1,this._hasWiredFilters=!1,this._widgetMenuStateCache=null,this._restrictAutoQuerying=!0,this._shouldAutoQueryOnBase=!this._restrictAutoQuerying,this._bypassConfiguredLayerValidation=!1,this.STR_PRODUCT_NAME="",this.STR_RC_GIS_CLOSE="",this.STR_RC_GIS_SELECTFEATS="",this.STR_RC_GIS_LOGINSELECTFEATS="",this.widgetConfig=null,this._widgetDivName="",this._widgetShowing=!1,this._widgetShowingDialogWiredUp=!1,this._isSelectToolActive=!1,this._isDeselectToolActive=!1,this._hasMenuClickOnceWired=!1,this._currentMenu=null,this._map=n.map,this._obApi=n.obApi,this._useOBHighlighting=n.useOBHighlighting||!1,this._cityworksProxyObj=n.cityworksProxyObj||null,this._isCityworksMode=this._cityworksProxyObj!==null,this._toolFillColor=n.toolFillColor||[246,239,229,.45],this._toolOutlineColor=n.toolOutlineColor||[255,121,0],this._drawType=this._determineEsriDrawType(n.selectionType),this._deselectDrawType=this._determineEsriDrawType(n.selectionType),this._queryDistance=n.queryDistance||3,this._disableInfoWindowInDrawMode=n.disableInfoWindowInDrawMode||!1,this._identifyQueryTolerance=this._getIdentifyQueryTolerance(n.identifyQueryTolerance),this._debugMode=n.debugMode||!1,this._queryArcGISDynamicMapServiceLayers=n.queryArcGISDynamicMapServiceLayers===undefined?!1:n.queryArcGISDynamicMapServiceLayers,this._addDynamicSelectionToMap=n.addDynamicSelectionToMap===undefined?!1:this._queryArcGISDynamicMapServiceLayers&&n.addDynamicSelectionToMap,this._pointHighlightSymbol=null,this._polygonHighlightSymbol=null,this._polylineHighlightSymbol=null,this._countSelectionComplete=0,this._selectableLayers=[],this._lastDynamicObLayersResult=[],this._selectionTool=null,this._isDrawToolActive=!1,this._selectionMethod=c.SELECTION_ADD,this._lastobFeatureLayersRetrieveData=null,this._useOBHighlighting){var t=n.selFillColor||[0,203,238,.35],i=n.selOutlineColor||[0,0,255];this.initSelectionSymbols(t,i)}this._wireupListeners();b._obApi.log("viewModel constructor - initialized view model.")},wireUpUI:function(n,t){var i,f,p,h,c,l,a,e,v,y;if(b.widgetConfig=t,b._setScopeTranslations(t),$(t.JQueryWidgetDivId).html(n),this._widgetDivName=t.JQueryWidgetDivId,t.ShouldUseJQueryUiDialog?$("#divObHeader").css("display","none"):t.ShouldShowTitle||t.ShouldShowClose?(t.ShouldShowClose?($("#ob_closeImg").click(function(){b.performCloseWidgetTasks(!0)}),t.ShouldShowTitle&&$("#ob_closeImg").attr("alt",b.STR_RC_GIS_CLOSE).attr("title",b.STR_RC_GIS_CLOSE)):$("#ob_closeImg").css("display","none"),t.ShouldShowTitle||$("#ob_title").html("&nbsp;"),t.WidgetCssZProp&&$(t.JQueryWidgetDivId).css("z-index",t.WidgetCssZProp)):$("#divObHeader").css("display","none"),i=!1,$(t.JQueryWidgetToggleButtonId).length>0){if(t.ShouldUseJQueryUiDialog){var r=t.DialogWidth,u=t.DialogHeight,o=550,s=400;r&&this._isInt(r)&&(o=r);u&&this._isInt(u)&&(s=u);$(t.JQueryWidgetToggleButtonId).click(function(){b._toggleWidget(o,s)})}else $(t.JQueryWidgetToggleButtonId).click(function(){$(t.JQueryWidgetDivId).toggle();b._widgetShowingDialogWiredUp===!1&&b.checkSessionAsync();b._widgetShowingDialogWiredUp=!0});i=!0}else t.ShouldUseJQueryUiDialog&&b._obApi.log("viewModel.wireUpUI: Missing JQueryWidgetToggleButtonId with id '"+t.JQueryWidgetToggleButtonId.replace("#","")+"' see Web.config appSettings for the widget, or pass in an override value",d.Error);if(f=b._isCityworksMode,!t.ShouldShowTopToolbar||f)$(".js_OB_ShowHideTopToolbar").css("display","none"),f&&b._obApi.log("viewModel.wireUpUI: widget viewModel is in Cityworks mode, top tools are disabled.",d.Warn);else{if(t.ShouldShowGeometryOptions?b._setGeometryOptionsStrings(t):($("#obDeselectTool_DownArrow").css("display","none"),$("#obSelectTool_DownArrow").css("display","none")),t.ShouldShowFeatureSelectionTools){t.ShouldShowDeselectTool?($("#ob_selectFeaturesImg").removeClass("ob-toolbar-button-select").addClass("obAddSelectionIcon"),p=b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_DESELECT"),h=b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_REMOVESELECTION"),$("#ob_btnDeselectTool").attr("title",h),c=function(){b._isDeselectToolActive?b._deactivateDeselectTool():b._activateDeselectTool()},$("#ob_btnDeselectTool").click(c)):($("#obDeselectTool").css("display","none"),$("#obDeselectTool_DownArrow").css("display","none"));var w=b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_SELECTFEATURES"),k=b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_CLEARSELECTEDFEATS"),g=b._getStrValue(t.TranslatedStrings,"STR_SELECT");$("#ob_selectFeaturesImg").attr("title",w);$("#ob_clearSelectionsImg").attr("title",k);l=function(){b._isSelectToolActive?b._deactivateSelectTool():b._activateSelectTool()};a=function(){b.clearSelection()};$("#ob_selectFeaturesImg").click(l);$("#ob_clearSelectionsImg").click(a)}else $(".js_OB_ShowHideSelectAndClearTools").css("display","none");$("#expand_collapse_features").attr("title",b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_TOGGLEVISIBILITY"));$("#label_features").text(b._getStrValue(t.TranslatedStrings,"STR_RC_GIS_FEATURESHEADING"));e=function(){$("#expand_collapse_features").hasClass("js-ob-invertArrow")?($("#expand_collapse_features").removeClass("js-ob-invertArrow"),$("#ob_top_toolbar").show()):($("#expand_collapse_features").addClass("js-ob-invertArrow"),$("#ob_top_toolbar").hide())};$("#expand_collapse_features").click(e);$("#label_features").click(e);t.ShouldShowRefreshTool?(v=b._getStrValue(t.TranslatedStrings,"STR_RC_REFRESH"),$("#ob_docsRefreshImg").attr("title",v),y=function(){b.refreshDocumentListAsync()},$("#ob_docsRefreshImg").click(y)):$("#obTopRefreshTool").css("display","none")}b._enableActionsMenuItems(t);b._wireUpUiTools(t);t.ShouldLoginOnLoad?setTimeout(function(){b.checkSessionAsync()},500):i||b._displayHtml("<p>"+b.STR_RC_GIS_SELECTFEATS+"<\/p>")},changeSelectionMethod:function(n){b._selectionMethod=n},restrictAutoQueryingForResults:function(n){b._restrictAutoQuerying=n;b._shouldAutoQueryOnBase=!n},setBypassConfigLayerCheck:function(n){b._bypassConfiguredLayerValidation=n},setActive:function(n){b._shouldAutoQueryOnBase=n},isActive:function(){return b._shouldAutoQueryOnBase},performCloseWidgetTasks:function(n){n&&$(b.widgetConfig.JQueryWidgetDivId).hide();b.clearSelection()},checkSessionAsync:function(){var n=$.Deferred();return this._toggleLoadingSpinner(!1),this._requiresOnBaseSessionAsync().then(function(t){t?b._displayHtml("<p>"+b.STR_RC_GIS_LOGINSELECTFEATS+"<\/p>"):b._displayHtml("<p>"+b.STR_RC_GIS_SELECTFEATS+"<\/p>");n.resolve(t)}).fail(function(t){b._obApi.log("viewModel.checkSessionAsync: error checking session "+t,d.Error);n.reject(t)}),n},initSelectionSymbols:function(n,t){this._pointHighlightSymbol=new e(e.STYLE_CIRCLE,12,new o(o.STYLE_SOLID,new h(t),2),new h(n));this._polygonHighlightSymbol=new s(s.STYLE_SOLID,new o(o.STYLE_SOLID,new h(t),2),new h(n));this._polylineHighlightSymbol=new o(o.STYLE_SOLID,new h(n),2)},deactivateDragSelectTool:function(){b._selectionTool&&b._isDrawToolActive&&(b._selectionTool.deactivate(),b._isDrawToolActive=!1,b._disableInfoWindowInDrawMode&&b._map.setInfoWindowOnClick(!0))},initDragSelectTool:function(){var t,n;if(!b._selectionTool){b._selectionTool=new w(b._map);t=new s(s.STYLE_SOLID,new o(o.STYLE_SOLID,new h(b._toolOutlineColor),2),new h(b._toolFillColor));b._selectionTool.fillSymbol=t;b._selectionTool.on("draw-complete",i.hitch(b,b._onDrawComplete))}b.deactivateDragSelectTool();n=b._drawType;b._isDeselectToolActive&&(n=b._deselectDrawType);b._selectionTool.activate(n);b._isDrawToolActive=!0;b._disableInfoWindowInDrawMode&&b._map.setInfoWindowOnClick(!1)},clearSelection:function(){var u,n,o,t,s;for(b._lastobFeatureLayersRetrieveData=null,n=0,u=b._selectableLayers.length;n<u;n++)b._selectableLayers[n].clearSelection();if(b._addDynamicSelectionToMap){b._lastDynamicObLayersResult=[];var f=b._map.graphicsLayerIds,e=b._map,i,r=[];for(n=0,o=f.length;n<o;n++)i=f[n],OBUtils.stringStartsWith(i,nt,!0)&&r.push(i);for(t=0,s=r.length;t<s;t++)e.removeLayer(e.getLayer(r[t]))}b._displayHtml("<p>"+b.STR_RC_GIS_SELECTFEATS+"<\/p>");b.deactivateDragSelectTool();b._clearActionMenuState();b._isSelectToolActive&&b._deactivateSelectTool();b._isDeselectToolActive&&b._deactivateDeselectTool()},refreshDocumentListAsync:function(){var n=$.Deferred(),t;return b._lastobFeatureLayersRetrieveData!==null||b.ignoreSelectableLayersDuringRefresh?b.retrieveAndDisplayHtmlFromobFeatureLayersAsync(b._lastobFeatureLayersRetrieveData).always(function(){n.resolve()}):(t=function(){b.setActive(!0);b._queryOnBase();n.resolve()},b._selectableLayers.length?t():b.getMapFeatureLayersAsync().then(t).fail(function(){n.resolve()})),n},getMapFeatureLayersAsync:function(){return b._obApi.getConfiguredLayersAsync().then(function(){var n=b._map.graphicsLayerIds,i=null,t,r;if(n&&n.hasOwnProperty("length"))for(t=0,r=n.length;t<r;t++)i=b._map.getLayer(n[t]),b._validateAndAddLayer(i);b._obApi.log("viewModel.getMapFeatureLayersAsync - [tally]: "+b._selectableLayers.length)})},cacheObFeatureLayersRetrieveData:function(n){b._lastobFeatureLayersRetrieveData=n},retrieveAndDisplayHtmlFromobFeatureLayersAsync:function(n){var t=$.Deferred();return b._toggleLoadingSpinner(!0),b._getHtmlFromApiAsync(n).then(b._displayHtml).always(function(){b._toggleLoadingSpinner(!1);t.resolve()}),t},_onEsriLayerAdd:function(n){this._obApi.log("viewModel._onEsriLayerAdd: layer received. attempting to add layer...");this._validateAndAddLayer(n.layer)},_onEsriLayerRemove:function(n){this._obApi.log("viewModel._onEsriLayerRemove: layer received. attempting to remove layer...");this._findAndRemoveLayer(n.layer)},_onDrawComplete:function(n){(b._isSelectToolActive||b._isDeselectToolActive)&&(this._obApi.log("viewModel._onDrawComplete: drawing complete. attempting to select features..."),b._lastobFeatureLayersRetrieveData=null,b.setActive(!0),b._queryArcGISDynamicMapServiceLayers?b._makeDynamicSelection(n.geometry).then(b._makeFeatureLayerSelection):b._makeFeatureLayerSelection(n.geometry))},_onSelectionComplete:function(){b._countSelectionComplete++;b._obApi.log("viewModel._onSelectionComplete: selection complete times: "+b._countSelectionComplete);b._countSelectionComplete===b._selectableLayers.length&&(b._countSelectionComplete=0,b._obApi.log("viewModel._onSelectionComplete: threshold reached (final selection complete)."),b._queryOnBase())},_convertDynamicToObLayersAsync:function(n){var t=$.Deferred(),i=function(){for(var f,d,g,l,e=[],a=b._map.layerIds,v,r,o,y,s,u,i,h,p,w,k,c=0,nt=a.length;c<nt;c++)if(v=a[c],r=b._map.getLayer(v),b._isValidDynamicLayer(r)){for(o=r.layerInfos,y=r.url,s=r.visibleLayers,u=[],f=0,d=o.length;f<d;f++)i=o[f],h=i.id,p=i.name,w=OBUtils.isArray(i.subLayerIds)&&i.subLayerIds.length>0,k=s.indexOf(h.toString())!==-1||s.indexOf(h)!==-1,!w&&k&&b._obApi.isConfiguredLayerId(p)&&u.push(i);u.length>0&&e.push({url:y,visibleLayerInfos:u})}e.length>0?(g=b._doDynamicLayersQueries(n,e),b._all(g).then(function(n){for(var i,r=[],u=0;u<n.length;u++)i=n[u],i&&r.push(i);b._lastDynamicObLayersResult.length>0?b._mergeDynamicObLayersResults(r):b._isSelectToolActive&&(b._lastDynamicObLayersResult=r);t.resolve()}).otherwise(function(n){t.reject(n)})):(l=[],b._lastDynamicObLayersResult=l,t.resolve(l))};return b._obApi.getConfiguredLayersAsync().then(i),t},_findCachedObLayer:function(n){for(var r=b._lastDynamicObLayersResult,u=null,i,f=-1,t=0,e=r.length;t<e;t++)if(i=r[t],n.LayerName===i.LayerName){u=i;f=t;break}return{layerIndex:f,obLayer:u}},_getMatchingFeatureIndex:function(n,t){for(var f=JSON.stringify(n),r=-1,u,i=0,e=t.length;i<e;i++)if(u=t[i],f===JSON.stringify(u)){r=i;break}return r},_mergeDynamicObLayersResults:function(n){var u=b._lastDynamicObLayersResult,r=b._selectionMethod===c.SELECTION_ADD,f,h,l,a,t,e,i,o,v,s,y;if(u.length>0)for(o=0,v=n.length;o<v;o++)if(f=n[o],a=b._findCachedObLayer(f),l=a.obLayer,l){for(t=l.Features,h=f.Features,s=0,y=h.length;s<y;s++)if(e=h[s],i=b._getMatchingFeatureIndex(e,t),r&&i!==-1)t[i]=e;else if(r&&i===-1)t.push(e);else if(!r&&i!==-1&&(t.splice(i,1),t.length===0)){u.splice(a.layerIndex,1);break}}else r&&u.push(f);else r&&(u=n)},_combineDynamicAndFeatureLayerResults:function(n){var r=b._lastDynamicObLayersResult,u=[],t,i,f;if(OBUtils.isArray(n)){for(t=null,i=0,f=n.length;i<f;i++)t=n[i],b._findCachedObLayer(t).obLayer===null&&u.push(t);u.length>0&&(r=r.concat(u))}return r},_queryOnBase:function(){b.isActive()?(b._restrictAutoQuerying&&b.setActive(!1),this._toggleLoadingSpinner(!0),b._obApi.getObFeaturesFromEsriLayersAsync(b._selectableLayers).then(b._combineDynamicAndFeatureLayerResults).then(b._getHtmlFromApiAsync).then(b._displayHtml).always(function(){b._toggleLoadingSpinner(!1)})):b._obApi.log("viewModel._queryOnBaseAsync: querying for results is currently disabled.")},_makeFeatureLayerSelection:function(n){var t=function(){b._selectableLayers.length>0?b._selectFeatures(n):b._queryOnBase()};b._selectableLayers.length?t():b.getMapFeatureLayersAsync().then(t)},_makeDynamicSelection:function(n){var t=$.Deferred();return b._convertDynamicToObLayersAsync(n).then(function(){t.resolve(n)}).fail(function(n){b._obApi.log("viewModel._onDrawComplete: An error occurred. "+n,d.Error)}),t},_doDynamicLayersQueries:function(n,t){var h=[],i=new p,e,r,o,c,s,l,a,u,v,f,w;for(i.distance=b._identifyQueryTolerance,i.geometry=n,i.outFields=["*"],i.returnGeometry=b._addDynamicSelectionToMap,i.spatialRelationship=p.SPATIAL_REL_INTERSECTS,u=0,v=t.length;u<v;u++)for(e=t[u],r=e.url,o=e.visibleLayerInfos,c=OBUtils.stringEndsWith("/",r,!1)?r:r+"/",f=0,w=o.length;f<w;f++)try{s=o[f];l=new y(c+s.id);a=l.execute(i).addCallback(b._createDynamicLayerQueryCallback(s.name));h.push(a)}catch(k){b._obApi.log("viewModel._doDynamicLayersQueries: An error occurred. "+k.message,d.Error)}return h},_getCenterPoint:function(n){var i=null,t=n.geometry.type;return t==="point"?i=n.geometry:t==="polygon"||t==="polyline"||t==="multipoint"?i=n.geometry.getExtent().getCenter():t==="extent"&&(i=n.geometry.getCenter()),i},_createDynamicLayerQueryCallback:function(n){return function(t){var k=null,r=t.features,d,o,g,tt,e,p,s,w,h,i,u,a,ut;if(r&&r.length>0){for(d=t.fields,o=[],i=0,u=r.length;i<u;i++)tt=r[i],g=b._obApi.createObFeature(tt.attributes,!0,d),o.push(g);if(o.length>0&&(k=b._obApi.createObLayer(n,o)),b._addDynamicSelectionToMap){var v=nt+n,it=OBUtils.isArray(b._map.graphicsLayerIds)&&b._map.graphicsLayerIds.indexOf(v)!==-1,rt=b._selectionMethod===c.SELECTION_ADD;if(!it&&rt){var y=new l({id:v}),ft=t.geometryType,et=b._getSelectionSymbol(ft);for(i=0,u=r.length;i<u;i++)y.add(r[i]);y.setRenderer(new f(et));b._map.addLayer(y)}else if(it)for(e=b._map.getLayer(v),i=0,u=r.length;i<u;i++)if(p=r[i],s=b._getCenterPoint(p),s){for(a=0,ut=e.graphics.length;a<ut;a++)if(w=e.graphics[a],h=b._getCenterPoint(w),h&&s.x===h.x&&s.y===h.y){e.remove(w);break}rt&&e.add(p)}}}return k}},_isValidDynamicLayer:function(n){var t=!1;return n&&n.visible&&OBUtils.isNotNullOrEmpty(n.url)&&n.hasOwnProperty("layerInfos")&&OBUtils.isArray(n.layerInfos)&&OBUtils.isArray(n.visibleLayers)&&n.visibleLayers.length>0&&(t=!0),t},_setInitialGeometryUiIcons:function(n){var t="",r=b._drawType,i;switch(r){case w.POINT:t="obSelectPoint";break;case w.POLYLINE:t="obSelectPolyline";break;case w.FREEHAND_POLYLINE:t="obSelectFreehandLine";break;case w.FREEHAND_POLYGON:t="obSelectFreehandPoly";break;case w.POLYGON:t="obSelectPolygon";break;case w.ELLIPSE:t="obSelectEllipse";break;default:t="obSelectRectangle"}$("#ob_selectFeaturesImg").addClass(t);$("[data-obRelatedIconClass=obSelectRectangle]").removeClass("obSelected");$("[data-obRelatedIconClass="+t+"]").addClass("obSelected");n.ShouldShowDeselectTool&&(i=t.replace("Select","DeSelect"),$("#ob_btnDeselectTool").addClass(i),$("[data-obRelatedIconClass=obDeSelectRectangle]").removeClass("obSelected"),$("[data-obRelatedIconClass="+i+"]").addClass("obSelected"))},_wireUpUiTools:function(n){if(n.ShouldShowGeometryOptions){$("#ob_selectFeaturesImg").removeClass("ob-toolbar-button-select");$("#ob_selectFeaturesImg").removeClass("obAddSelectionIcon");$("#ob_btnDeselectTool").removeClass("obSubtractSelectionIcon");b._setInitialGeometryUiIcons(n);var t=function(){this.classList.remove("obShow")},i=function(n){var i=this.id+tt,t=document.getElementById(i),r=t.classList.contains("obShow");r?t.classList.remove("obShow"):($(".js-obMenu").removeClass("obShow"),t.classList.add("obShow"),b._currentMenu=t,n.stopPropagation(),b._hasMenuClickOnceWired||(document.addEventListener("click",b._onGeometryMenuClickOnceOutside),b._hasMenuClickOnceWired=!0))},r=function(){var n=$(this),f=n.attr("data-obRelatedIconClass"),e=f.indexOf("obDeSelect")!==-1,i=null,r,t,u,o;for(e?(i=$("#ob_btnDeselectTool"),b._deselectDrawType=b._determineEsriDrawType(n.attr("data-obDrawType"))):(i=$("#ob_selectFeaturesImg"),b._drawType=b._determineEsriDrawType(n.attr("data-obDrawType"))),r=i[0].classList,t="",u=0,o=r.length;u<o;u++)if(t=r[u],t.indexOf("obSelect")!==-1||t.indexOf("obDeSelect")!==-1){r.remove(t);break}i.addClass(f);e?b._activateDeselectTool():b._activateSelectTool();n.siblings().removeClass("obSelected");n.addClass("obSelected")};$(".js-obMenu").mouseleave(t);$(".js-obGeomMenuItem").click(r);$(".js-obHasMenu").click(i)}},_onGeometryMenuClickOnceOutside:function(n){var t=b._currentMenu;t&&!t.contains(n.target)&&($(".js-obMenu").removeClass("obShow"),document.removeEventListener("click",b._onGeometryMenuClickOnceOutside),b._hasMenuClickOnceWired=!1)},_setGeometryOptionsStrings:function(n){var t=n.TranslatedStrings;$(".js-obHasMenu").attr("title",b._getStrValue(t,"STR_RC_GIS_SHOWGEOMOPTIONS"));$(".js-obTxtRectangle").text(b._getStrValue(t,"STR_OS_LIFECYCLE_SHAPE_RECTANGLE"));$(".js-obTxtEllipse").text(b._getStrValue(t,"STR_UC_ELLIPSE"));$(".js-obTxtPolygon").text(b._getStrValue(t,"STR_UC_POLYGON"));$(".js-obTxtPoint").text(b._getStrValue(t,"STR_RC_GIS_POINT"));$(".js-obTxtFreehandPolygon").text(b._getStrValue(t,"STR_RC_GIS_LASSO"));$(".js-obTxtFreehandPolyline").text(b._getStrValue(t,"STR_RC_GIS_FREEHANDLINE"));$(".js-obTxtPolyline").text(b._getStrValue(t,"STR_UC_LINE"));$("[data-obDrawType=POINT]").attr("title",b._getStrValue(t,"STR_RC_GIS_POINTTOOLTIP"));$("[data-obDrawType=POLYLINE]").attr("title",b._getStrValue(t,"STR_RC_GIS_POLYLINETOOLTIP"));$("[data-obDrawType=FREEHAND_POLYLINE]").attr("title",b._getStrValue(t,"STR_RC_GIS_FREEHANDLINETOOLTIP"));$("[data-obDrawType=RECTANGLE]").attr("title",b._getStrValue(t,"STR_RC_GIS_RECTANGLETOOLTIP"));$("[data-obDrawType=POLYGON]").attr("title",b._getStrValue(t,"STR_RC_GIS_POLYGONTOOLTIP"));$("[data-obDrawType=FREEHAND_POLYGON]").attr("title",b._getStrValue(t,"STR_RC_GIS_FREEHANDPOLYTOOLTIP"));$("[data-obDrawType=ELLIPSE]").attr("title",b._getStrValue(t,"STR_RC_GIS_ELLIPSETOOLTIP"))},_enableActionsMenuItems:function(n){var r,t,i;if(n.HitListSettings.IsHitListWorkflowColumn){r=function(){b._executeMenuAction(k.CloseWorkflowDialog)};$("#ob_hidden_divs_closeWorkflow_button").on("click",r);$("#ob_hidden_divs_closeWorkflow_button").text(b._getStrValue(n.TranslatedStrings,"STR_RC_GIS_CLOSE"))}if(n.WidgetActionMenuOptions.IsShowActionMenu){t="obActionMenuHidden";i=function(){b._executeMenuAction(k.ToggleMenu)};$("#ob_expand_collapse_actions").on("click",i);$("#ob_actions_header_label").on("click",i);b._obApi.log("viewModel._enableActionsMenuItems: Action menu enabled.",d.Info);n.WidgetActionMenuOptions.IsShowActionMenuAttach&&$("#ob_actions_attach").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuDetach&&$("#ob_actions_detach").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuDownload&&$("#ob_actions_sendto").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuFilter&&$("#ob_actions_filter").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuFolderLink&&$("#ob_actions_folder").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuImport&&$("#ob_actions_import").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuLogout&&$("#ob_actions_logout").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuRefresh&&$("#ob_actions_refresh").removeClass(t);n.WidgetActionMenuOptions.IsShowActionMenuWebLink&&$("#ob_actions_weblink").removeClass(t);b._setActionMenuOptionsStrings(n);b._hasInitialActionMenuItems=!0}else this._obApi.log("viewModel._enableActionsMenuItems: Action menu disabled.",d.Info)},_setActionMenuOptionsStrings:function(n){var t=n.TranslatedStrings,i,r,u,f,e,o;$("#ob_expand_collapse_actions").attr("title",b._getStrValue(t,"STR_RC_GIS_TOGGLEVISIBILITY"));$("#ob_actions_header_label").text(b._getStrValue(t,"STR_ACTIONS"));i=b._getStrValue(t,"STR_RC_GIS_IMPORT");$("#ob_actions_import_label").attr("title",i);$("#ob_actions_import_button").attr("title",i);$("#ob_actions_import_label").text(i);r=b._getStrValue(t,"STR_RC_GIS_ATTACH");$("#ob_actions_attach_label").attr("title",r);$("#ob_actions_attach_button").attr("title",r);$("#ob_actions_attach_label").text(r);u=b._getStrValue(t,"STR_RC_GIS_DETACH");$("#ob_actions_detach_label").attr("title",u);$("#ob_actions_detach_button").attr("title",u);$("#ob_actions_detach_label").text(u);f=b._getStrValue(t,"STR_RC_SENDTO");$("#ob_actions_sendto_label").attr("title",f);$("#ob_actions_sendto_button").attr("title",f);$("#ob_actions_sendto_label").text(f);e=b._getStrValue(t,"STR_RC_REFRESH");$("#ob_actions_refresh_label").attr("title",e);$("#ob_actions_refresh_button").attr("title",e);$("#ob_actions_refresh_label").text(e);$("#ob_actions_filter_label").text(b._getStrValue(t,"STR_RC_GIS_SETFILTERS"));$("#ob_actions_folder_label").text(b._getStrValue(t,"STR_RC_GIS_FOLDERLINK"));$("#ob_actions_weblink_label").text(b._getStrValue(t,"STR_RC_GIS_WEBLINK"));o=b._getStrValue(t,"STR_RC_LOGOUT");$("#ob_actions_logout_label").text(o);$("#div_LoginLogout_Prompt").attr("title",o);$("#ob_hidden_divs_loginLogout_button").text(o);$("#div_Workflow_Results").attr("title",b._getStrValue(t,"STR_RC_GIS_VIEWWORKFLOW"));$("#ob_hidden_divs_loginLogout_span").text(b._getStrValue(t,"STR_RC_GIS_CLICKLOGOUT"));b._setActionMenuState(n.WidgetActionMenuState)},_clearActionMenuState:function(){b._obApi.hasSessionAsync().then(function(n){if(n)try{var t=b._obApi.getWebApiUrl()+"/SaveSelectedFeatures";b._obApi.execAjaxRequestAsync(t,"text",null,"application/json","POST").then(b._getGetActionMenuStateFromApiAsync)}catch(i){b._obApi.log("viewModel.clearActionMenuState: "+i.message,d.Error)}else $("#ob_actions_div").addClass("obActionMenuHidden")})},_setActionMenuState:function(n){var i=b.widgetConfig.TranslatedStrings,c,l,t,u,g,nt,tt,a,v,it,y,rt,p,ut,w,ft,d,e,et,s,h,ot;if((b._hasInitialActionMenuItems===!0||b._obApi.hasSessionAsync())&&(b._widgetMenuStateCache=n,OnBaseWebHitListUtils.getInstance(n),c="obActionMenuHidden",l=!1,n.IsUserLoggedIn?(l=!0,$("#ob_actions_div").removeClass(c)):$("#ob_actions_div").addClass(c),l)){if(t="disabled",u=$("#ob_actions_import"),n.HasImportRight&&n.HasImportDoctypes&&u.hasClass("obActionMenuHidden")===!0&&u.removeClass("obActionMenuHidden"),u.hasClass("obActionMenuHidden")===!1){var r=$("#ob_actions_import_button"),o=$("#ob_actions_import_label"),f="";if(n.HasSelectedFeaturesForImportDoctypes){if(f=b._getStrValue(i,"STR_RC_GIS_IMPORT"),r.attr("title",f),o.attr("title",f),r.removeClass("ob-upload-disabled"),r.addClass("ob-upload"),o.removeClass(t),u.removeClass(t),b._hasWiredImport===!1){g=function(){b._executeMenuAction(k.Import)};r.on("click",g);b._hasWiredImport=!0}}else f=b._getStrValue(i,"STR_RC_GIS_SELNOTCONFIGUREDIMPORT"),r.attr("title",f),o.attr("title",f),r.removeClass("ob-upload"),r.addClass("ob-upload-disabled"),o.addClass(t),u.addClass(t),r.off("click"),b._hasWiredImport=!1}if($("#ob_actions_attach").hasClass("obActionMenuHidden")===!1)if(b._setFeatureSelectTitle(n,"#ob_actions_attach",b._getStrValue(i,"STR_RC_GIS_ATTACH")),n.FeatureCount>0){if($("#ob_actions_attach_button").removeClass("ob-attach-disabled"),$("#ob_actions_attach_button").addClass("ob-attach"),$("#ob_actions_attach_label").removeClass(t),$("#ob_actions_attach").removeClass(t),b._hasWiredAttach===!1){nt=function(){b._executeMenuAction(k.Attach)};$("#ob_actions_attach_button").on("click",nt);b._hasWiredAttach=!0}}else $("#ob_actions_attach_button").removeClass("ob-attach"),$("#ob_actions_attach_button").addClass("ob-attach-disabled"),$("#ob_actions_attach").addClass(t),$("#ob_actions_attach_label").addClass(t),$("#ob_actions_attach_button").off("click"),b._hasWiredAttach=!1;if($("#ob_actions_detach").hasClass("obActionMenuHidden")===!1)if(b._setFeatureSelectTitle(n,"#ob_actions_detach",b._getStrValue(i,"STR_RC_GIS_DETACH")),n.FeatureCount>0){if($("#ob_actions_detach_button").removeClass("ob-detach-disabled"),$("#ob_actions_detach_button").addClass("ob-detach"),$("#ob_actions_detach_label").removeClass(t),$("#ob_actions_detach").removeClass(t),b._hasWiredDetach===!1){tt=function(){b._executeMenuAction(k.Detach)};$("#ob_actions_detach_button").on("click",tt);b._hasWiredDetach=!0}}else $("#ob_actions_detach_button").removeClass("ob-detach"),$("#ob_actions_detach_button").addClass("ob-detach-disabled"),$("#ob_actions_detach").addClass(t),$("#ob_actions_detach_label").addClass(t),$("#ob_actions_detach_button").off("click"),b._hasWiredDetach=!1;if($("#ob_actions_filter").hasClass("obActionMenuHidden")===!1)if(b._setFeatureSelectTitle(n,"#ob_actions_filter",b._getStrValue(i,"STR_RC_GIS_SETFILTERS")),n.IsFilterActive||b._obApi.hasFilterApplied()?(a=b._getStrValue(i,"STR_RC_GIS_SETFILTERS_ACTIVE"),$("#ob_actions_filter_label").attr("title",a),$("#ob_actions_filter_button").attr("title",a),$("#ob_actions_filter_button").addClass("active")):(v=b._getStrValue(i,"STR_RC_GIS_SETFILTERS"),$("#ob_actions_filter_label").attr("title",v),$("#ob_actions_filter_button").attr("title",v),$("#ob_actions_filter_button").removeClass("active")),n.IsUserLoggedIn){if($("#ob_actions_filter_label").removeClass(t),$("#ob_actions_filter").removeClass(t),b._hasWiredFilters===!1){it=function(){b._executeMenuAction(k.Filter)};$("#ob_actions_filter_button").on("click",it);b._hasWiredFilters=!0}}else $("#ob_actions_filter_label").addClass(t),$("#ob_actions_filter").addClass(t),$("#ob_actions_filter_button").off("click"),b._hasWiredFilters=!1;if($("#ob_actions_sendto").hasClass("obActionMenuHidden")===!1)if(n.DocumentSendToCount>0){if($("#ob_actions_sendto_button").removeClass("ob-downloadzip-disabled"),$("#ob_actions_sendto_button").addClass("ob-downloadzip"),y=b._getStrValue(i,"STR_RC_SENDTO"),$("#ob_actions_sendto_label").attr("title",y),$("#ob_actions_sendto_button").attr("title",y),$("#ob_actions_sendto_label").removeClass(t),$("#ob_actions_sendto").removeClass(t),b._hasWiredDownload===!1){rt=function(){b._executeMenuAction(k.Download)};$("#ob_actions_sendto_button").on("click",rt);b._hasWiredDownload=!0}}else p=b._getStrValue(i,"STR_RC_GIS_SENDTO_COUNTZERO"),$("#ob_actions_sendto_label").attr("title",p),$("#ob_actions_sendto_button").attr("title",p),$("#ob_actions_sendto_button").removeClass("ob-downloadzip"),$("#ob_actions_sendto_button").addClass("ob-downloadzip-disabled"),$("#ob_actions_sendto").addClass(t),$("#ob_actions_sendto_label").addClass(t),$("#ob_actions_sendto_button").off("click"),b._hasWiredDownload=!1;if(n.HasFolderRight&&$("#ob_actions_folder").hasClass("obActionMenuHidden")===!0&&$("#ob_actions_folder").removeClass("obActionMenuHidden"),$("#ob_actions_folder").hasClass("obActionMenuHidden")===!1)if(b._setFeatureSelectTitle(n,"#ob_actions_folder",b._getStrValue(i,"STR_RC_GIS_FOLDERLINK")),n.HasFolderForLayer===!0&&n.FeatureCount===1){if($("#ob_actions_folder_label").attr("title",n.FolderLinkName),$("#ob_actions_folder_button").attr("title",n.FolderLinkName),$("#ob_actions_folder_button").removeClass("ob-folderlink-disabled"),$("#ob_actions_folder_button").addClass("ob-folderlink"),$("#ob_actions_folder_label").removeClass(t),$("#ob_actions_folder").removeClass(t),b._hasWiredFolder===!1){ut=function(){b._executeMenuAction(k.Folder)};$("#ob_actions_folder_button").on("click",ut);b._hasWiredFolder=!0}}else n.HasFolderForLayer||n.FeatureCount!==1?(e=b._getStrValue(i,"STR_RC_GIS_SELECTASINGLEFEATURE"),$("#ob_actions_folder_label").attr("title",e),$("#ob_actions_folder_button").attr("title",e)):(w=b._getStrValue(i,"STR_RC_GIS_FOLDERLINKNOLAYER").replace("{0}",n.SingleFeatureLayerName),$("#ob_actions_folder_label").attr("title",w),$("#ob_actions_folder_button").attr("title",w)),$("#ob_actions_folder_button").removeClass("ob-folderlink"),$("#ob_actions_folder_button").addClass("ob-folderlink-disabled"),$("#ob_actions_folder_label").addClass(t),$("#ob_actions_folder").addClass(t),$("#ob_actions_folder_button").off("click"),b._hasWiredFolder=!1;if($("#ob_actions_weblink").hasClass("obActionMenuHidden")===!1)if(b._setFeatureSelectTitle(n,"#ob_actions_weblink",b._getStrValue(i,"STR_RC_GIS_WEBLINK")),n.HasWebPageForLayer&&n.FeatureCount===1){if($("#ob_actions_weblink_label").attr("title",n.WebLinkName),$("#ob_actions_weblink_button").attr("title",n.WebLinkName),$("#ob_actions_weblink_button").removeClass("ob-weblink-disabled"),$("#ob_actions_weblink_button").addClass("ob-weblink"),$("#ob_actions_weblink_label").removeClass(t),$("#ob_actions_weblink").removeClass(t),b._hasWiredWeblink===!1){ft=function(){b._executeMenuAction(k.Weblink)};$("#ob_actions_weblink_button").on("click",ft);b._hasWiredWeblink=!0}}else n.HasWebPageForLayer||n.FeatureCount!==1?(e=b._getStrValue(i,"STR_RC_GIS_SELECTASINGLEFEATURE"),$("#ob_actions_weblink_label").attr("title",e),$("#ob_actions_weblink_button").attr("title",e)):(d=b._getStrValue(i,"STR_RC_GIS_WEBLINKNOLAYER").replace("{0}",n.SingleFeatureLayerName),$("#ob_actions_weblink_label").attr("title",d),$("#ob_actions_weblink_button").attr("title",d)),$("#ob_actions_weblink_button").removeClass("ob-weblink"),$("#ob_actions_weblink_button").addClass("ob-weblink-disabled"),$("#ob_actions_weblink").addClass(t),$("#ob_actions_weblink_label").addClass(t),$("#ob_actions_weblink_button").off("click"),b._hasWiredWeblink=!1;if($("#ob_actions_logout").hasClass("obActionMenuHidden")===!1){if(b._hasWiredLogout===!1){et=function(){b._executeMenuAction(k.Logout)};$("#ob_actions_logout_button").on("click",et);b._hasWiredLogout=!0}$("#ob_actions_logout").removeClass(t);$("#ob_actions_logout_label").removeClass(t);n.IsUserLoggedIn?(s=b._getStrValue(i,"STR_RC_LOGOUT"),$("#ob_actions_logout_label").attr("title",s),$("#ob_actions_logout_button").attr("title",s),$("#ob_actions_logout_label").text(s)):(h=b._getStrValue(i,"STR_RC_LOGIN"),$("#ob_actions_logout_label").attr("title",h),$("#ob_actions_logout_button").attr("title",h),$("#ob_actions_logout_label").text(h))}if($("#ob_actions_refresh").hasClass("obActionMenuHidden")===!1&&b._hasWiredRefresh===!1){ot=function(){b._executeMenuAction(k.Refresh)};$("#ob_actions_refresh_button").on("click",ot);b._hasWiredRefresh=!0;$("#ob_actions_refresh").removeClass(t);$("#ob_actions_refresh_label").removeClass(t)}}},_setFeatureSelectTitle:function(n,t,i){var e=b.widgetConfig.TranslatedStrings,r=b._getStrValue(e,"STR_RC_GIS_SELECTFEATURES_ENABLE"),u=t+"_button",f=t+"_label";n.FeatureCount===0?($(u).attr("title",r),$(f).attr("title",r)):($(u).attr("title",i),$(f).attr("title",i))},_executeMenuAction:function(n){var t=b._widgetMenuStateCache,r,i;switch(n){case k.Import:OnBaseWebHitListUtils.getInstance(t).importDoc();break;case k.Filter:OnBaseWebHitListUtils.getInstance(t).filter();break;case k.Attach:OnBaseWebHitListUtils.getInstance(t).attach();break;case k.Detach:OnBaseWebHitListUtils.getInstance(t).detach();break;case k.Download:OnBaseWebHitListUtils.getInstance(t).downloadZip();break;case k.Refresh:b.refreshDocumentListAsync();break;case k.Folder:OnBaseWebHitListUtils.getInstance(t).showFolderLink();break;case k.Weblink:r=b.widgetConfig.WindowSettings.WebLink;OnBaseWebHitListUtils.getInstance(t).showWebLinkAsync(r.Width,r.Height);break;case k.ToggleMenu:i=$("#ob_expand_collapse_actions");i.hasClass("js-ob-invertChevron")?(i.removeClass("js-ob-invertChevron"),$("#ob_toolbar").css("display","")):(i.addClass("js-ob-invertChevron"),$("#ob_toolbar").css("display","none"));break;case k.Logout:OnBaseWebHitListUtils.getInstance(t).logout(!1).then(function(){b.clearSelection();b._obApi.clearObConfiguredLayersCache();var n=b.widgetConfig.TranslatedStrings;b._displayHtml("<p>"+b._getStrValue(n,"STR_RC_GIS_LOGIN_REFRESH")+"<\/p>");b._getGetActionMenuStateFromApiAsync()});break;case k.LogoutLoginPrompt:OnBaseWebHitListUtils.getInstance(t).logout_LogIn(!0);break;case k.CloseWorkflowDialog:OnBaseWebHitListUtils.getInstance(t).closeWorkflow();break;default:b._obApi.log("viewModel._executeMenuAction: Invalid action menu item: "+n,d.Error)}},_determineEsriDrawType:function(n){var t=w.RECTANGLE;if(typeof n=="string")switch(n.toUpperCase()){case"POINT":t=w.POINT;break;case"POLYLINE":t=w.POLYLINE;break;case"FREEHAND_POLYLINE":t=w.FREEHAND_POLYLINE;break;case"FREEHAND_POLYGON":t=w.FREEHAND_POLYGON;break;case"POLYGON":t=w.POLYGON;break;case"ELLIPSE":t=w.ELLIPSE}return t},_activateDeselectTool:function(){b._isSelectToolActive&&b._deactivateSelectTool();var n=$("#ob_btnDeselectTool");b.widgetConfig.ShouldShowGeometryOptions||n.addClass("obSubtractSelectionSelectedIcon").removeClass("obSubtractSelectionIcon");n.addClass("selected");b.changeSelectionMethod(c.SELECTION_SUBTRACT);b._isDeselectToolActive=!0;b.initDragSelectTool()},_deactivateDeselectTool:function(){var n=$("#ob_btnDeselectTool");b.widgetConfig.ShouldShowGeometryOptions||n.addClass("obSubtractSelectionIcon").removeClass("obSubtractSelectionSelectedIcon");n.removeClass("selected");b.changeSelectionMethod(c.SELECTION_ADD);b.deactivateDragSelectTool();b._isDeselectToolActive=!1},_activateSelectTool:function(){b._isDeselectToolActive&&b._deactivateDeselectTool();var n=$("#ob_selectFeaturesImg"),t=b.widgetConfig.ShouldShowDeselectTool,i=b.widgetConfig.ShouldShowGeometryOptions;t&&!i&&n.addClass("obAddSelectionSelectedIcon").removeClass("obAddSelectionIcon");t||i||n.addClass("ob-button-selected");n.addClass("selected");b._isSelectToolActive=!0;b.initDragSelectTool()},_deactivateSelectTool:function(){var n=$("#ob_selectFeaturesImg"),t,i;b.widgetConfig.ShouldShowDeselectTool&&!b.widgetConfig.ShouldShowGeometryOptions&&n.addClass("obAddSelectionIcon").removeClass("obAddSelectionSelectedIcon");t=b.widgetConfig.ShouldShowDeselectTool;i=b.widgetConfig.ShouldShowGeometryOptions;t||i||n.removeClass("ob-button-selected");n.removeClass("selected");b.deactivateDragSelectTool();b._isSelectToolActive=!1},_displayHtml:function(n){n?$("#ob_docs_div").html(n):b._obApi.log("viewModel._displayHtml: No html was received.",d.Error)},_getHtmlFromApiAsync:function(n){var t=$.Deferred();return n===undefined||n===null||n.length===0?(b._clearActionMenuState(),t.resolve("<p>"+b._getStrValue(b.widgetConfig.TranslatedStrings,"STR_RC_GIS_SELECTFEATS")+"<\/p>")):b._obApi.retrieveDocumentsHtmlAsync(n).then(function(n){b._getGetActionMenuStateFromApiAsync().then(function(){t.resolve(n)})}),t},_getGetActionMenuStateFromApiAsync:function(){var n=$.Deferred();return b._hasInitialActionMenuItems===!0?b._obApi.getGetActionMenuStateAsync().then(function(t){b._setActionMenuState(t);b._obApi.log("viewModel._getGetActionMenuStateFromApiAsync: Action Menu state updated.",d.Info);n.resolve(!0)}):n.resolve(!0),n},_wireupListeners:function(){this._map.on("layer-add",i.hitch(this,this._onEsriLayerAdd));this._map.on("layer-remove",i.hitch(this,this._onEsriLayerRemove));window.addEventListener("message",function(n){b._processChildWindowMessages(n.data)},!1)},_processChildWindowMessages:function(n){var t=n.pageName,o=n.data,s=n.isApply,i,u,r,f,e;if(s){i=g.UnKnown;u=t.toLowerCase();u==g.LoginClose?i=g.LoginClose:u==g.Filter&&(i=g.Filter);switch(i){case g.LoginClose:b._obApi.hasSessionAsync().then(function(){b._executeMenuAction(k.Refresh)});b._obApi.log("viewModel._processChildWindowMessages: Child window applied from: "+t,d.Info);break;case g.Filter:r=o;b.widgetConfig.WidgetActionMenuOptions.IsPersistFilterInBrowser===!1?(f=b._obApi.determineFilterLocalStorageKeyName(),r?(e=JSON.stringify(r),ObGisStorage.setItem(f,e,EnumObStorageType.SESSION),b._obApi.log("Filter set for session only.")):(ObGisStorage.removeItem(f,EnumObStorageType.SESSION),b._obApi.log("Filter cleared on session."))):r?b._obApi.log("Filter set persistent."):b._obApi.log("Filter cleared persistent.");b._executeMenuAction(k.Refresh);b._obApi.log("viewModel._processChildWindowMessages: Child window applied from: "+t,d.Info);break;default:b._obApi.log("viewModel._processChildWindowMessages: Child window action unsupported: '"+t+"'",d.Info)}}else b._obApi.log("viewModel._processChildWindowMessages: Child window reports from: "+t,d.Info)},_toggleWidget:function(n,t){var i=this.widgetConfig.JQueryWidgetDivId;this._widgetShowing?($(i).dialog("close"),$(i).hide(),this._widgetShowing=!1):($(i).show(),this._widgetShowingDialogWiredUp?$(i).dialog("open"):($(i).dialog({resizable:!0,modal:!1,width:n,height:t,minWidth:315,classes:{"ui-dialog-content":"obJQueryUIDialogContent"}}),$(i).bind("dialogclose",function(){b._widgetShowing=!1}),this._widgetShowingDialogWiredUp=!0,this.checkSessionAsync()),this._widgetShowing=!0)},_isInt:function(n){return n===parseInt(n,10)?!0:!1},_selectFeatures:function(n){var t=new p,i,u,f,r,e;for(t.geometry=n,i=n.type,(i==="point"||i==="multipoint"||i==="polyline")&&(t.distance=b._queryDistance),t.outFields=["*"],u=b._selectableLayers,f=b._selectionMethod,r=0,e=u.length;r<e;r++)u[r].selectFeatures(t,f)},_setScopeTranslations:function(n){b.STR_PRODUCT_NAME=b._getStrValue(n.TranslatedStrings,"STR_PRODUCT_NAME");b.STR_RC_GIS_CLOSE=b._getStrValue(n.TranslatedStrings,"STR_RC_GIS_CLOSE");b.STR_RC_GIS_SELECTFEATS=b._getStrValue(n.TranslatedStrings,"STR_RC_GIS_SELECTFEATS");b.STR_RC_GIS_LOGINSELECTFEATS=b._getStrValue(n.TranslatedStrings,"STR_RC_GIS_LOGINSELECTFEATS")},_getStrValue:function(n,t){var r="Translation not found.",i;return n!==undefined?(i=n[t],i!==undefined&&(r=i)):b._obApi.log("viewModel._getStrValue: translationObject is undefined",d.Error),r},_getSelectionSymbol:function(n){var t=null;switch(n){case"esriGeometryPolygon":t=b._polygonHighlightSymbol;break;case"esriGeometryPolyline":t=b._polylineHighlightSymbol;break;default:t=b._pointHighlightSymbol}return t},_setLayerSelectionSymbol:function(n){n.setSelectionSymbol(b._getSelectionSymbol(n.geometryType))},_addFeatureLayer:function(n,t){var r=b._bypassConfiguredLayerValidation?!0:b._obApi.isConfiguredLayerId(n);if(r){t.on("selection-complete",i.hitch(this,this._onSelectionComplete));this._useOBHighlighting&&this._setLayerSelectionSymbol(t);this._selectableLayers.push(t);this._obApi.log("viewModel._addFeatureLayer: added layer [name]: "+n+" [tally]: "+this._selectableLayers.length)}else b._obApi.log("viewModel._addFeatureLayer: no session or layer not configured. [name]: "+n)},_validateAndAddLayer:function(n){var r=n.hasOwnProperty("type")&&n.type==="Feature Layer",u=b._selectableLayers.indexOf(n)===-1,t,i;r&&u?b._isCityworksMode?(t=b._cityworksProxyObj.map.layers.getOriginalLayerNameFromSelectableLayerId(n.id),typeof t=="string"&&t.length>0?(n.obCityworksName=t,b._addFeatureLayer(t,n)):b._obApi.log("viewModel._validateAndAddLayer: [cityworks mode] originalLayerName for layer: "+n.name+" is empty, this is not a selected layer and will not be used.")):b._addFeatureLayer(n.name,n):(i="[id]: "+n.id,r?u||(i+=" [name]: "+n.name,b._obApi.log("viewModel._validateAndAddLayer: layer already added: "+i)):b._obApi.log("viewModel._validateAndAddLayer: ignore non-FeatureLayer: "+i))},_findAndRemoveLayer:function(n){var t=this._selectableLayers.indexOf(n),i;t!==-1&&(i=this._selectableLayers.splice(t,1),this._obApi.log("viewModel._findAndRemoveLayer: removed layer [id]: "+n.id+" [name]: "+n.name+" [tally]: "+this._selectableLayers.length))},_toggleLoadingSpinner:function(n){b._obApi.toggleLoadingSpinner(n)},_requiresOnBaseSessionAsync:function(){var n=$.Deferred();return this._obApi.requiresSessionAsync().then(function(t){t&&b._obApi.promptForSession();n.resolve(t)}).fail(function(t){b._obApi.log("viewModel._requiresOnBaseSessionAsync: error checking session "+t,d.Error);n.reject(t)}),n},_getIdentifyQueryTolerance:function(n){var t=3;return b._isInt(n)&&n>=0&&(t=n),t},_doQuery:function(n){var t=new p,f,i,u,o,s;if(t.distance=b._identifyQueryTolerance,t.geometry=n,t.outFields=["*"],t.returnGeometry=!0,t.spatialRelationship=p.SPATIAL_REL_INTERSECTS,f=[],i=b._selectableLayers,i.length>0)for(u=0,o=i.length;u<o;u++){var e=i[u],h=new y(e.url),c=e.name;e.visible&&(s=h.execute(t).addCallback(function(n){return r.map(n.features,function(n){return n})}),f.push(s))}else b._obApi.log("viewModel._doQuery: There are no selectable layers in memory to query.",d.Warn);return{featureLayers:i,deferredObjects:f}},_doIdentify:function(n){var t=new v,e,i,u,s,o,h;if(t.geometry=n,t.tolerance=b._identifyQueryTolerance,t.returnGeometry=!0,t.layerOption=v.LAYER_OPTION_ALL,t.width=b._map.width,t.height=b._map.height,t.mapExtent=b._map.extent,e=[],i=b._selectableLayers,i.length>0){for(u=0,s=i.length;u<s;u++)if(o=i[u],o.visible){var f=o.url,c=parseInt(f.substring(f.lastIndexOf("/")+1)),l=f.substring(0,f.lastIndexOf("/")),y=new a(l);t.layerIds=[c];h=y.execute(t).addCallback(function(n){return r.map(n,function(n){return n.feature})});e.push(h)}}else b._obApi.log("viewModel._doIdentify: There are no selectable layers in memory to identify.",d.Warn);return{featureLayers:i,deferredObjects:e}},_updateHitListAsync:function(n){var t=$.Deferred(),r=n?n.featureLayers:null,i=n?n.deferredObjects:null;return r!==null&&i!=null?b._all(i).then(function(i){b.updateHitListFromIdentifyOrQueryAsync(n.featureLayers,i).then(function(){t.resolve()}).fail(function(){t.reject()})}):(b._getHtmlFromApiAsync(null).then(b._displayHtml),t.resolve()),t},_all:function(n){return u(n)}})});